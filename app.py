#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å°è¯´æ¨æ–‡æ–‡æ¡ˆç”Ÿæˆå™¨ - Webåº”ç”¨ç‰ˆæœ¬
æä¾›å‹å¥½çš„Webç•Œé¢ï¼Œæ”¯æŒå®æ—¶ç”Ÿæˆå’Œé¢„è§ˆ
"""

from flask import Flask, render_template, request, jsonify
import random
import json
import requests
from datetime import datetime
from typing import Dict, List
import os
from pathlib import Path

# è·å–é¡¹ç›®æ ¹ç›®å½•
if __name__ == '__main__':
    # å¼€å‘ç¯å¢ƒ
    project_root = Path(__file__).parent
else:
    # Vercelç¯å¢ƒ
    project_root = Path(__file__).parent.parent

# åˆ›å»ºFlaskåº”ç”¨ï¼ŒæŒ‡å®šæ¨¡æ¿å’Œé™æ€æ–‡ä»¶è·¯å¾„
app = Flask(__name__, 
           template_folder=str(project_root / 'templates'),
           static_folder=str(project_root / 'static'))

# Vercelç¯å¢ƒé…ç½®
if os.environ.get('VERCEL'):
    app.config['TEMPLATES_AUTO_RELOAD'] = False
    app.config['SEND_FILE_MAX_AGE_DEFAULT'] = 31536000  # 1å¹´ç¼“å­˜
else:
    app.config['TEMPLATES_AUTO_RELOAD'] = True
    app.config['SEND_FILE_MAX_AGE_DEFAULT'] = 0

class NovelPromotionWebGenerator:
    def __init__(self):
        self.deepseek_api_key = "sk-3f70e594368645d7a45fbdc1c173fe61"
        self.api_url = "https://api.deepseek.com/v1/chat/completions"
        
        # 6ç§æ–‡æ¡ˆé£æ ¼é…ç½®
        self.style_configs = {
            "å·¥å…·åˆ†äº«å‹": {
                "description": "åˆ†äº«å®ç”¨å·¥å…·å’Œç»éªŒï¼Œå»ºç«‹ä¸“ä¸šå½¢è±¡",
                "hook_style": "ç»éªŒåˆ†äº«å¼å¼€å¤´",
                "tone": "å‹å¥½ä¸“ä¸šï¼Œä¹äºåˆ†äº«"
            },
            "é¿é›·è­¦å‘Šå‹": {
                "description": "é€šè¿‡è¸©å‘ç»å†å»ºç«‹ä¿¡ä»»ï¼Œæä¾›é¿å‘æŒ‡å—",
                "hook_style": "è­¦å‘Šé¢„è­¦å¼å¼€å¤´",
                "tone": "ç´§è¿«æ„Ÿï¼Œè¿‡æ¥äººå£å»"
            },
            "æˆæœå±•ç¤ºå‹": {
                "description": "ç”¨æ•°æ®å’Œç»“æœå¸å¼•å…³æ³¨ï¼Œå±•ç¤ºæˆåŠŸæ¡ˆä¾‹",
                "hook_style": "æˆæœå±•ç¤ºå¼å¼€å¤´",
                "tone": "è‡ªä¿¡æˆåŠŸï¼Œæ¿€åŠ±ä»–äºº"
            },
            "å·¥å…·åˆé›†å‹": {
                "description": "ç³»ç»Ÿæ€§ä»‹ç»å¤šä¸ªå·¥å…·ï¼Œæä¾›å®Œæ•´è§£å†³æ–¹æ¡ˆ",
                "hook_style": "éœ€æ±‚å¯¼å‘å¼å¼€å¤´",
                "tone": "ç³»ç»Ÿå…¨é¢ï¼Œå®ç”¨å¯¼å‘"
            },
            "é¿å‘æŒ‡å—å‹": {
                "description": "é¢„è­¦å¼å†…å®¹ï¼Œå¢åŠ ä»·å€¼æ„Ÿå’Œå¯ä¿¡åº¦",
                "hook_style": "é¿é›·é¢„è­¦å¼å¼€å¤´",
                "tone": "ç†æ€§åˆ†æï¼Œå®¢è§‚ä¸­ç«‹"
            },
            "å¹²è´§åˆé›†å‹": {
                "description": "å…¨é¢çš„çŸ¥è¯†æ•´ç†åˆ†äº«ï¼Œä»·å€¼æ„Ÿæ»¡æ»¡",
                "hook_style": "ä»·å€¼æ‰¿è¯ºå¼å¼€å¤´",
                "tone": "å¹²è´§æ»¡æ»¡ï¼Œè¶…å€¼åˆ†äº«"
            }
        }
        
        # é­”éŸ³å·¥åŠè¯¦ç»†ä¿¡æ¯
        self.moyin_comprehensive = {
            "åŸºæœ¬ä¿¡æ¯": {
                "åç§°": "é­”éŸ³å·¥åŠ",
                "å®šä½": "ä¸“ä¸šAIé…éŸ³è½¯ä»¶çš„å…¨æ–¹ä½è§£å†³æ–¹æ¡ˆ",
                "ç‰¹è‰²": "è¾¾äººçƒ­æ¨çš„çŸ­è§†é¢‘/æœ‰å£°ä¹¦AIé…éŸ³å¹³å°"
            },
            "æ ¸å¿ƒåŠŸèƒ½": {
                "å£°éŸ³åº“": "500+ä¼˜è´¨å£°éŸ³ï¼Œå¤šé¢†åŸŸè¦†ç›–",
                "AIé…éŸ³": "æ–‡å­—è½¬è¯­éŸ³ï¼Œè‡ªç„¶æµç•…",
                "éŸ³é¢‘ç¼–è¾‘": "Wordèˆ¬ä½“éªŒçš„éŸ³é¢‘ç¼–è¾‘å™¨",
                "è°ƒéŸ³åŠŸèƒ½": "è¿‘20ä¸ªè°ƒéŸ³åŠŸèƒ½ï¼Œé€å¥è¯•å¬ã€å¤šéŸ³å­—ã€åœé¡¿ã€é‡è¯»ã€å±€éƒ¨å˜é€Ÿ",
                "å£°éŸ³å®šåˆ¶": "AIå£°éŸ³å…‹éš†ï¼Œä¸ªæ€§åŒ–å®šåˆ¶",
                "è§†é¢‘äº‘å‰ªè¾‘": "æ™ºèƒ½å‰ªè¾‘å·¥å…·ï¼Œå†…å®¹ä¸€é”®è§†é¢‘åŒ–"
            },
            "çƒ­é—¨å£°éŸ³": ["é­”äº‘ç†™", "é­”æ™“æ¢¦", "é­”å½±æºªpro", "é‡‡é‡‡", "é­”é’è¨€Pro", "é­”è¶…è¶Š", "è´å„¿"],
            "æ¨èå‚æ•°": {
                "å¥³é¢‘çˆ†æ¬¾": "é­”æ™“æ¢¦ | é»˜è®¤ | è¯­é€Ÿ1.5 | è§£è¯´æ¨¡å¼å¼€å¯",
                "ç”·é¢‘çˆ†æ¬¾": "é­”äº‘ç†™ | ä¸¥è‚ƒ | è¯­é€Ÿ1.2 | è¯­è°ƒ-1 | è§£è¯´æ¨¡å¼å¼€å¯"
            },
            "é€‚ç”¨åœºæ™¯": ["å°è¯´æ¨æ–‡", "çŸ­è§†é¢‘é…éŸ³", "æœ‰å£°ä¹¦åˆ¶ä½œ", "è§£è¯´è§†é¢‘", "å•†ä¸šé…éŸ³", "ç›´æ’­åŠ©ç†"]
        }
        
        # å…¶ä»–å·¥å…·åˆ†ç±»åº“
        self.tool_categories = {
            "é…éŸ³ç±»å·¥å…·": [
                {"name": "TTSé…éŸ³", "desc": "æ“ä½œç®€å•å°ç™½å‹å¥½ï¼Œæ€§ä»·æ¯”ä¹‹é€‰ï¼Œé€šå¸¸æ¯”å…¶ä»–ä¾¿å®œ", "rating": 4},
                {"name": "è®¯é£é…éŸ³", "desc": "ç§‘å¤§è®¯é£å‡ºå“ï¼Œä¸“ä¸šçº§é…éŸ³æ•ˆæœï¼Œä¼ä¸šçº§åº”ç”¨", "rating": 5},
                {"name": "ä¹é”¤é…éŸ³", "desc": "ä»·æ ¼ä¾¿å®œé€‚åˆé¢„ç®—æœ‰é™ï¼ŒéŸ³è´¨ä¸€èˆ¬ä½†å¤Ÿç”¨", "rating": 3},
                {"name": "é…éŸ³ç¥å™¨", "desc": "ä¸“ä¸šé…éŸ³å·¥å…·ï¼Œæ”¯æŒç”·é¢‘å¥³é¢‘å‚æ•°è°ƒèŠ‚", "rating": 4}
            ],
            "è§†é¢‘å‰ªè¾‘å·¥å…·": [
                {"name": "å‰ªæ˜ ", "desc": "æ°¸è¿œçš„æ»´ç¥ï¼å‰ªè¾‘ã€å­—å¹•ã€ç‰¹æ•ˆã€éŸ³ç”»åŒæ­¥ä¸€é”®æå®šï¼Œæ–°æ‰‹å¿…å¤‡", "rating": 5},
                {"name": "æ¼«å½±å¿«å‰ª", "desc": "æ¼«ç”»æ¨æ–‡åˆ¶ä½œç¥å™¨ï¼Œå†…ç½®æµ·é‡ç´ æï¼Œä¸€é”®ç”Ÿæˆæ¼«ç”»æ¨æ–‡", "rating": 4},
                {"name": "æ¨æ–‡åŠ©æ‰‹", "desc": "ä¸€ç«™å¼æ¨æ–‡åˆ¶ä½œå·¥å…·ï¼Œè§†é¢‘å‰ªè¾‘ã€å­—å¹•ç”Ÿæˆå…¨æå®š", "rating": 4}
            ],
            "å»æ°´å°å·¥å…·": [
                {"name": "çš®çš®å»æ°´å°", "desc": "å…è´¹æ— å¹¿å‘Šï¼Œå•å¼ å¤„ç†è¶…å¿«ï¼Œç®€å•æ˜“ç”¨", "rating": 4},
                {"name": "å“¼å“¼çŒ«", "desc": "æ‰¹é‡å¤„ç†yydsï¼Œä»˜è´¹ä½†è¶…å€¼ï¼Œé€‚åˆå¤§é‡ç´ æ", "rating": 5},
                {"name": "é­”éŸ³å·¥åŠå»æ°´å°", "desc": "é›†æˆåœ¨é­”éŸ³å·¥åŠå†…ï¼Œå¤åˆ¶é“¾æ¥å³å¯å»æ°´å°", "rating": 4}
            ],
            "å®‰å…¨æ£€æµ‹å·¥å…·": [
                {"name": "å¥æ— å¿§", "desc": "ä¸€é”®æ£€æµ‹æ•æ„Ÿè¯ï¼Œæ£€æµ‹å…¨é¢å‡†ç¡®ï¼Œä¿å‘½å¿…å¤‡", "rating": 5},
                {"name": "å¥æ˜“ç½‘", "desc": "è€ç‰Œæ•æ„Ÿè¯æ£€æµ‹å·¥å…·ï¼Œå¯é ç¨³å®šï¼Œæ‰¹é‡ç­›æŸ¥é«˜æ•ˆ", "rating": 5}
            ],
            "AIåˆ›ä½œåŠ©æ‰‹": [
                {"name": "è±†åŒ…AI", "desc": "å­—èŠ‚è·³åŠ¨å‡ºå“ï¼Œæ™ºèƒ½å¯¹è¯åŠ©æ‰‹ï¼Œæ–‡æœ¬åˆ›ä½œæ¶¦è‰²ä¿®æ”¹åŸæ–‡", "rating": 4},
                {"name": "ChatGPT", "desc": "å…¨çƒé¢†å…ˆAIèŠå¤©æœºå™¨äººï¼Œå†…å®¹åˆ›ä½œçµæ„Ÿã€è¯­è¨€ç¿»è¯‘æ ·æ ·ç²¾é€š", "rating": 5},
                {"name": "DeepSeek", "desc": "å›½äº§AIæ–°æ˜Ÿï¼Œä¸“ä¸šæ–‡æœ¬å¤„ç†ï¼Œæ¶¦è‰²ä¿®æ”¹åŸæ–‡å°è¯´æ•ˆæœä½³", "rating": 4},
                {"name": "ThinkAI", "desc": "ä¸€ç«™å¼AIå·¥å…·ç½‘ç«™ï¼ŒGPTå›½å†…é•œåƒï¼ŒAIå·¥å…·å¯¼èˆª", "rating": 4}
            ],
            "æ¨æ–‡å¹³å°": [
                {"name": "çŸ¥ä¹æ•…äº‹ä¼š", "desc": "çŸ­ç¯‡æ¨æ–‡é¦–é€‰ï¼Œå‰§æƒ…ç´§å‡‘æ”¹æ–‡è½»æ¾ï¼Œèµ·é‡å¿«æ–°æ‰‹å‹å¥½", "rating": 5},
                {"name": "ç•ªèŒ„å°è¯´", "desc": "é•¿ç¯‡IPå¤šæµé‡å¤§ï¼Œéœ€è¦æ›´å¼ºæ”¹æ–‡èƒ½åŠ›ï¼Œæ”¶ç›Šç¨³å®š", "rating": 5},
                {"name": "ä¸ƒçŒ«å°è¯´", "desc": "å…è´¹é˜…è¯»æ¨¡å¼ï¼Œç”¨æˆ·åŸºæ•°å¤§ï¼Œéœ€è¦ç²¾ç»†åŒ–è¿è¥", "rating": 4},
                {"name": "äº‘æ¨å·¨é‡", "desc": "å°è¯´æˆæƒå¹³å°ï¼Œæµ·é‡ä¼˜è´¨å°è¯´èµ„æºï¼Œè½»æ¾è·å–æˆæƒ", "rating": 4}
            ],
            "è®¾è®¡å·¥å…·": [
                {"name": "åˆ›å®¢è´´", "desc": "å›¾æ–‡å…šç¦éŸ³ï¼Œæ’ç‰ˆè®¾è®¡è¶…æ–¹ä¾¿ï¼Œ0åŸºç¡€ä¹Ÿèƒ½ä¸Šæ‰‹", "rating": 4},
                {"name": "Canva", "desc": "å›½é™…åŒ–è®¾è®¡å·¥å…·ï¼Œæ¨¡æ¿ä¸°å¯Œä¸“ä¸šï¼Œè®¾è®¡æ„Ÿå¼º", "rating": 5},
                {"name": "ç¨¿å®šè®¾è®¡", "desc": "åœ¨çº¿è®¾è®¡å¹³å°ï¼Œæ’ç‰ˆåŠ å›¾æ–¹ä¾¿ï¼Œé€‚åˆå¿«é€Ÿåˆ¶ä½œ", "rating": 4}
            ]
        }
        
        # çƒ­é—¨æ ‡é¢˜æ¨¡æ¿åº“
        self.dynamic_title_templates = [
            "æ’­æ”¾{low_num}å’Œ{high_num}å·®åœ¨å“ªï¼Ÿè¿™äº›å·¥å…·æˆ‘ç”¨äº†{years}å¹´",
            "çœŸå¿ƒå»ºè®®â—{field}å·¥å…·æ”¶è—è¿™ç¯‡å°±å¤Ÿäº†â—",
            "{percent}%çš„{platform}åšä¸»éƒ½åœ¨ç”¨çš„{count}ä¸ªå·¥å…·ğŸ”¥",
            "åš{field}å·¥å…·å¤§æ­ç§˜~ï¼ˆå…¨ï¼‰äº²æµ‹å¥½ç”¨åˆ°çˆ†ğŸ”¥",
            "æ–°æ‰‹çœŸçš„ä¸è¦ä¹±åš{field}ï¼Œåæœå¤ªä¸¥é‡ï¼",
            "æ²¡æƒ³åˆ°{field}ç«Ÿç„¶è¢«æˆ‘åšæˆäº†ï¼æœˆå…¥{income}çš„ç§˜å¯†",
            "æ•‘å‘½å•Šâ—{field}æ–°æ‰‹å¿…çœ‹é¿å‘æŒ‡å—ï¼Œéª‚é†’ä¸€ä¸ªæ˜¯ä¸€ä¸ª",
            "{field}ä»0åˆ°{achievement}çš„å·¥å…·æ¸…å•ï¼Œå…¨ç¨‹å¹²è´§",
            "è¿™{count}ä¸ª{field}å·¥å…·ï¼Œæ—©ç”¨æ—©å—ç›Šï¼æ–°æ‰‹é€Ÿç ",
            "{field}å·¥å…·åˆé›†ï½œ{count}ä¸ªç¥å™¨åŠ©ä½ æœˆå…¥è¿‡ä¸‡ğŸ”¥"
        ]

    def call_deepseek_api(self, prompt: str) -> str:
        """è°ƒç”¨DeepSeek API"""
        headers = {
            "Authorization": f"Bearer {self.deepseek_api_key}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": "deepseek-chat",
            "messages": [{"role": "user", "content": prompt}],
            "temperature": 0.8,  # å¢åŠ åˆ›æ„åº¦
            "max_tokens": 2000   # å‡å°‘tokenæ•°é‡æé«˜é€Ÿåº¦
        }
        
        # å¢åŠ é‡è¯•æœºåˆ¶
        max_retries = 3
        for attempt in range(max_retries):
            try:
                # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°90ç§’
                response = requests.post(self.api_url, headers=headers, json=data, timeout=90)
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content']
                elif response.status_code == 429:  # é¢‘ç‡é™åˆ¶
                    if attempt < max_retries - 1:
                        import time
                        time.sleep(5)  # ç­‰å¾…5ç§’åé‡è¯•
                        continue
                    return "APIè°ƒç”¨é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•"
                else:
                    return f"APIè°ƒç”¨å¤±è´¥ (çŠ¶æ€ç : {response.status_code})\nè¯·æ£€æŸ¥APIå¯†é’¥å’Œç½‘ç»œè¿æ¥"
            except requests.exceptions.Timeout:
                if attempt < max_retries - 1:
                    continue  # é‡è¯•
                return "APIè°ƒç”¨è¶…æ—¶ï¼Œç½‘ç»œè¿æ¥å¯èƒ½ä¸ç¨³å®šï¼Œè¯·ç¨åé‡è¯•"
            except requests.exceptions.ConnectionError:
                if attempt < max_retries - 1:
                    import time
                    time.sleep(3)
                    continue
                return "ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
            except Exception as e:
                if attempt < max_retries - 1:
                    continue
                return f"APIè°ƒç”¨å¼‚å¸¸: {str(e)}"

    def select_tools_by_count(self, count: int, exclude_moyin: bool = True) -> List[Dict]:
        """æ ¹æ®æ•°é‡æ™ºèƒ½é€‰æ‹©å·¥å…·"""
        all_tools = []
        for category, tools in self.tool_categories.items():
            for tool in tools:
                tool_copy = tool.copy()
                tool_copy['category'] = category
                all_tools.append(tool_copy)
        
        # ç¡®ä¿æ¯ä¸ªç±»åˆ«éƒ½æœ‰ä»£è¡¨
        selected = []
        categories = list(self.tool_categories.keys())
        
        # å…ˆä»æ¯ä¸ªç±»åˆ«é€‰ä¸€ä¸ªé«˜è¯„åˆ†çš„
        for category in categories:
            category_tools = [t for t in all_tools if t['category'] == category]
            if category_tools:
                best_tool = max(category_tools, key=lambda x: x['rating'])
                selected.append(best_tool)
                all_tools.remove(best_tool)
        
        # è¡¥å……åˆ°æŒ‡å®šæ•°é‡
        remaining_count = count - 1 - len(selected)  # -1 for é­”éŸ³å·¥åŠ
        if remaining_count > 0 and all_tools:
            additional = random.sample(all_tools, min(remaining_count, len(all_tools)))
            selected.extend(additional)
        
        return selected[:count-1]  # ç¡®ä¿ä¸è¶…è¿‡æŒ‡å®šæ•°é‡

    def generate_smart_titles(self, style: str, count: int = 5) -> List[str]:
        """ç”Ÿæˆæ™ºèƒ½æ ‡é¢˜"""
        titles = []
        templates = random.sample(self.dynamic_title_templates, min(count, len(self.dynamic_title_templates)))
        
        # æ ¹æ®é£æ ¼è°ƒæ•´å‚æ•°èŒƒå›´
        style_params = {
            "å·¥å…·åˆ†äº«å‹": {"field": "å°è¯´æ¨æ–‡", "tone": "åˆ†äº«"},
            "é¿é›·è­¦å‘Šå‹": {"field": "å°è¯´æ¨æ–‡", "tone": "è­¦å‘Š"},
            "æˆæœå±•ç¤ºå‹": {"field": "å°è¯´æ¨æ–‡", "tone": "æˆæœ"},
            "å·¥å…·åˆé›†å‹": {"field": "æ¨æ–‡åˆ¶ä½œ", "tone": "åˆé›†"},
            "é¿å‘æŒ‡å—å‹": {"field": "çŸ­è§†é¢‘", "tone": "æŒ‡å—"},
            "å¹²è´§åˆé›†å‹": {"field": "æ–°åª’ä½“è¿è¥", "tone": "å¹²è´§"}
        }
        
        base_params = style_params.get(style, {"field": "å°è¯´æ¨æ–‡", "tone": "åˆ†äº«"})
        
        for template in templates:
            params = {
                "low_num": random.choice(["500", "1000", "2000"]),
                "high_num": random.choice(["50w", "100w", "500w"]),
                "years": random.choice(["3", "5", "8"]),
                "field": base_params["field"],
                "platform": random.choice(["å°çº¢ä¹¦", "æŠ–éŸ³", "Bç«™"]),
                "count": random.choice(["6", "8", "10"]),
                "percent": random.choice(["85", "90", "95"]),
                "achievement": random.choice(["æœˆå…¥è¿‡ä¸‡", "ç™¾ä¸‡æ’­æ”¾", "10wç²‰ä¸"]),
                "income": random.choice(["5k", "1w", "2w"])
            }
            
            try:
                title = template.format(**params)
                titles.append(title)
            except KeyError:
                titles.append(template.replace('{', '').replace('}', ''))
        
        return titles

    def create_enhanced_prompt(self, style: str, tool_count: int, selected_tools: List[Dict]) -> str:
        """åˆ›å»ºå¢å¼ºç‰ˆAIæç¤ºè¯"""
        style_info = self.style_configs[style]
        
        prompt = f"""
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°è¯´æ¨æ–‡è¥é”€ä¸“å®¶ï¼Œè¯·ç”Ÿæˆä¸€ç¯‡{style}çš„å°è¯´æ¨æ–‡åˆ†äº«æ–‡æ¡ˆã€‚

## æ–‡æ¡ˆè¦æ±‚
**é£æ ¼**: {style} - {style_info['description']}
**è¯­è°ƒ**: {style_info['tone']}
**å¼€å¤´**: {style_info['hook_style']}
**å­—æ•°**: 700å­—å·¦å³

## å¿…é¡»åŒ…å«çš„æ ¸å¿ƒå·¥å…·
**é­”éŸ³å·¥åŠ** (é‡ç‚¹æ¨è):
{json.dumps(self.moyin_comprehensive, ensure_ascii=False, indent=2)}

## å…¶ä»–æ¨èå·¥å…·
{json.dumps(selected_tools, ensure_ascii=False, indent=2)}

## å†…å®¹ç»“æ„è¦æ±‚
1. **å¸å¼•åŠ›å¼€å¤´**: ä½¿ç”¨{style_info['hook_style']}ï¼Œç«‹å³æŠ“ä½è¯»è€…æ³¨æ„åŠ›
2. **é­”éŸ³å·¥åŠç®€å•ç§è‰**: ç”¨1-2å¥è¯ç®€å•ä»‹ç»å…¶äº®ç‚¹åŠŸèƒ½ï¼Œè‡ªç„¶èå…¥æ¨è
3. **å…¶ä»–å·¥å…·ä»‹ç»**: 
   - å¦‚æœæ€»å·¥å…·æ•°â‰¤8ä¸ª: æ¯ä¸ªå·¥å…·ç”¨1å¥è¯ä»‹ç»æ ¸å¿ƒåŠŸèƒ½
   - å¦‚æœæ€»å·¥å…·æ•°>8ä¸ª: æŒ‰åˆ†ç±»ç®€æ´ç½—åˆ—ï¼Œä¸€å¥è¯æ¦‚æ‹¬ä¸»è¦ç”¨é€”
4. **å®ç”¨æŠ€å·§**: æä¾›å…·ä½“çš„ä½¿ç”¨å»ºè®®å’Œå‚æ•°è®¾ç½®
5. **é¿å‘æé†’**: åˆ†äº«å®ç”¨çš„æ³¨æ„äº‹é¡¹

## å†™ä½œé£æ ¼
- ä½¿ç”¨é€‚é‡è¡¨æƒ…ç¬¦å·å¢åŠ æ´»è·ƒåº¦
- è¯­è¨€äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹åˆ†äº«ç»éªŒ
- åŒ…å«å…·ä½“æ•°æ®å’Œæ¡ˆä¾‹æå‡å¯ä¿¡åº¦
- åˆ†ç‚¹åˆ†æ®µï¼Œä¾¿äºé˜…è¯»
- ä½“ç°å°è¯´æ¨æ–‡é¢†åŸŸçš„ä¸“ä¸šæ€§
- **æ ¼å¼è¦æ±‚**: é¿å…ä½¿ç”¨è¿‡å¤šçš„#å·æ ‡é¢˜ï¼Œç”¨æ•°å­—åºå·ã€å°æ ‡é¢˜æˆ–è¡¨æƒ…ç¬¦å·æ¥åˆ†æ®µ

## é‡è¦æé†’
**ä¸¥æ ¼æ§åˆ¶å­—æ•°åœ¨700å­—å·¦å³ï¼Œä¸è¦è¶…è¿‡750å­—**
- é­”éŸ³å·¥åŠä»‹ç»æ§åˆ¶åœ¨50å­—ä»¥å†…
- å…¶ä»–å·¥å…·ä»‹ç»è¦ç®€æ´ç²¾ç‚¼
- æ•´ä½“å†…å®¹ç´§å‡‘æœ‰åŠ›ï¼Œé¿å…å†—é•¿æè¿°

è¯·ç›´æ¥è¾“å‡ºå®Œæ•´çš„æ–‡æ¡ˆå†…å®¹ï¼Œæ— éœ€é¢å¤–è¯´æ˜ã€‚
"""
        return prompt

    def generate_image_suggestions(self, style: str, count: int = 2) -> List[str]:
        """æ ¹æ®é£æ ¼ç”Ÿæˆé…å›¾å»ºè®®"""
        base_suggestions = {
            "å·¥å…·åˆ†äº«å‹": [
                "å°é¢ï¼šå°è¯´æ¨æ–‡å·¥å…·åˆ†äº«ä¸»é¢˜èƒŒæ™¯ + é­”éŸ³å·¥åŠlogoå±…ä¸­ + 'å®ç”¨å·¥å…·æ¨è'å¤§å­—æ ‡é¢˜ + ä¸‹æ–¹ç½—åˆ—6-8ä¸ªå·¥å…·å›¾æ ‡ç½‘æ ¼ + åº•éƒ¨'äº²æµ‹å¥½ç”¨'æ ‡ç­¾ + æ¸©æš–æ©™è‰²è°ƒ",
                "å°é¢ï¼šæ‰‹æœºå±å¹•æˆªå›¾æ‹¼è´´é£æ ¼ + å±•ç¤ºé­”éŸ³å·¥åŠç•Œé¢å’Œå…¶ä»–å·¥å…·ç•Œé¢ + 'æˆ‘åœ¨ç”¨çš„ç¥å™¨'æ‰‹å†™å­—ä½“æ ‡é¢˜ + å·¦å³åˆ†æ å¸ƒå±€å±•ç¤ºå·¥å…·æ•ˆæœå¯¹æ¯” + æ¸…æ–°è“ç»¿è‰²è°ƒ",
                "å°é¢ï¼šå·¥å…·ç®±æ¦‚å¿µè®¾è®¡ + é­”éŸ³å·¥åŠä½œä¸ºä¸»è¦å·¥å…·å±…ä¸­æ”¾å¤§ + å‘¨å›´ç¯ç»•å…¶ä»–å°å·¥å…·å›¾æ ‡ + 'å°è¯´æ¨æ–‡å¿…å¤‡ç¥å™¨'é†’ç›®æ ‡é¢˜ + ç§‘æŠ€æ„Ÿç´«è‰²æ¸å˜èƒŒæ™¯"
            ],
            "é¿é›·è­¦å‘Šå‹": [
                "å°é¢ï¼šçº¢è‰²è­¦å‘ŠèƒŒæ™¯ + 'é¿å‘æŒ‡å—'å¤§å­—æ ‡é¢˜ + ä¸­å¤®æ”¾ç½®è¸©å‘vsæˆåŠŸçš„å¯¹æ¯”å›¾ç¤º + é­”éŸ³å·¥åŠä½œä¸ºæ¨èè§£å†³æ–¹æ¡ˆé«˜äº®æ˜¾ç¤º + åº•éƒ¨'è¡€æ³ªæ•™è®­'å°å­—æé†’",
                "å°é¢ï¼šäº¤é€šæ ‡å¿—é£æ ¼è®¾è®¡ + çº¢è‰²ç¦æ­¢æ ‡è¯†è¦†ç›–é”™è¯¯åšæ³• + ç»¿è‰²å¯¹å‹¾æ ‡è¯†æ­£ç¡®æ–¹æ³• + é­”éŸ³å·¥åŠç­‰å·¥å…·ä½œä¸ºå®‰å…¨é€‰æ‹©å±•ç¤º + 'æ–°æ‰‹å¿…çœ‹'æ ‡ç­¾",
                "å°é¢ï¼šæ¼«ç”»é£æ ¼æ’ç”» + å°äººè¸©å‘åœºæ™¯ + é­”éŸ³å·¥åŠä½œä¸ºæ•‘æ˜Ÿå‡ºç° + 'è¿™äº›å‘æˆ‘éƒ½è¸©è¿‡'å¯¹è¯æ¡† + é»„è‰²è­¦ç¤ºè‰²è°ƒ + åº•éƒ¨ç½—åˆ—å¸¸è§é”™è¯¯"
            ],
            "æˆæœå±•ç¤ºå‹": [
                "å°é¢ï¼šæ•°æ®å¯è§†åŒ–é£æ ¼ + æ’­æ”¾é‡å¢é•¿æ›²çº¿å›¾å±…ä¸­ + é­”éŸ³å·¥åŠç­‰å·¥å…·logoä½œä¸ºå¢é•¿èŠ‚ç‚¹ + 'æœˆå…¥è¿‡ä¸‡å®å½•'é‡‘è‰²æ ‡é¢˜ + æ·±è“å•†åŠ¡èƒŒæ™¯ + å…·ä½“æ”¶ç›Šæ•°å­—å±•ç¤º",
                "å°é¢ï¼šå‰åå¯¹æ¯”æ‹¼å›¾ + å·¦ä¾§'ä½¿ç”¨å‰'ç°æš—æ•°æ® + å³ä¾§'ä½¿ç”¨å'äº®çœ¼æˆç»© + ä¸­é—´é­”éŸ³å·¥åŠç­‰å·¥å…·ä½œä¸ºè½¬æŠ˜ç‚¹ + 'é€†è¢­ä¹‹è·¯'åŠ±å¿—æ ‡é¢˜ + æ¸å˜è‰²å½©",
                "å°é¢ï¼šæˆåŠŸæ¡ˆä¾‹å±•ç¤ºå¢™ + å¤šä¸ªçˆ†æ¬¾è§†é¢‘ç¼©ç•¥å›¾æ‹¼è´´ + é­”éŸ³å·¥åŠé…éŸ³æ•ˆæœæ³¢å½¢å›¾ + 'è¿™äº›çˆ†æ¬¾éƒ½åœ¨ç”¨'æ ‡é¢˜ + é‡‘è‰²å¥–æ¯å…ƒç´  + å…·ä½“æ’­æ”¾é‡æ ‡æ³¨"
            ],
            "å·¥å…·åˆé›†å‹": [
                "å°é¢ï¼šå·¥å…·å¤§å…¨æµ·æŠ¥é£æ ¼ + ç½‘æ ¼å¸ƒå±€å±•ç¤ºæ‰€æœ‰å·¥å…· + é­”éŸ³å·¥åŠå æ®Cä½ + 'å°è¯´æ¨æ–‡å·¥å…·å…¨å®¶æ¡¶'æ ‡é¢˜ + æ¯ä¸ªå·¥å…·é…ç®€çŸ­åŠŸèƒ½è¯´æ˜ + æ•´æ´ç™½è‰²èƒŒæ™¯",
                "å°é¢ï¼šæ€ç»´å¯¼å›¾è®¾è®¡ + ä¸­å¿ƒ'å°è¯´æ¨æ–‡'èŠ‚ç‚¹ + åˆ†æ”¯è¿æ¥å„ç±»å·¥å…· + é­”éŸ³å·¥åŠåˆ†æ”¯æœ€ç²—æœ€äº® + 'ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ'å‰¯æ ‡é¢˜ + å½©è‰²åˆ†ç±»æ ‡è¯†",
                "å°é¢ï¼šå·¥å…·é“¾æµç¨‹å›¾ + ä»åˆ›ä½œåˆ°å‘å¸ƒçš„å®Œæ•´æµç¨‹ + æ¯ä¸ªç¯èŠ‚æ ‡æ³¨å¯¹åº”å·¥å…· + é­”éŸ³å·¥åŠåœ¨é…éŸ³ç¯èŠ‚çªå‡ºæ˜¾ç¤º + 'é«˜æ•ˆåˆ›ä½œæµæ°´çº¿'æ ‡é¢˜ + æµç•…ç®­å¤´è¿æ¥"
            ],
            "é¿å‘æŒ‡å—å‹": [
                "å°é¢ï¼šæ£€æŸ¥æ¸…å•é£æ ¼ + çº¸è´¨ä¾¿ç­¾è´´è®¾è®¡ + æ¯æ¡é¿å‘å»ºè®®é…å¯¹å‹¾å›¾æ ‡ + é­”éŸ³å·¥åŠä½œä¸ºæ¨èé€‰é¡¹é«˜äº® + 'é¿å‘å¿…çœ‹æ¸…å•'æ‰‹å†™æ ‡é¢˜ + æ¸©é¦¨é»„è‰²ä¾¿ç­¾èƒŒæ™¯",
                "å°é¢ï¼šæ—¶é—´çº¿è®¾è®¡ + å±•ç¤ºå¹³å°è§„åˆ™å˜åŒ–å†ç¨‹ + å…³é”®èŠ‚ç‚¹æ ‡æ³¨å½±å“ + é­”éŸ³å·¥åŠç­‰å®‰å…¨å·¥å…·æ¨è + 'è§„åˆ™å˜è¿å²'æ ‡é¢˜ + ä¸¥è‚ƒç°è“è‰²è°ƒ",
                "å°é¢ï¼šé—®ç­”å¯¹è¯æ¡†è®¾è®¡ + Q&Aå½¢å¼å±•ç¤ºå¸¸è§é—®é¢˜ + é­”éŸ³å·¥åŠç­‰ä½œä¸ºè§£å†³æ–¹æ¡ˆ + 'å¸¸è§é—®é¢˜è§£ç­”'æ ‡é¢˜ + å¯¹è¯æ°”æ³¡å…ƒç´  + å‹å¥½ç»¿è‰²ä¸»è‰²è°ƒ"
            ],
            "å¹²è´§åˆé›†å‹": [
                "å°é¢ï¼šçŸ¥è¯†å¡ç‰‡æ‹¼è´´ + å¤šå¼ å°å¡ç‰‡å±•ç¤ºä¸åŒæŠ€å·§ + é­”éŸ³å·¥åŠå¡ç‰‡å±…ä¸­æ”¾å¤§ + 'å¹²è´§æ»¡æ»¡'å°ç« æ•ˆæœ + å¤å¤ç‰›çš®çº¸è´¨æ„Ÿ + æ‰‹ç»˜é£æ ¼è¾¹æ¡†",
                "å°é¢ï¼šä»·å€¼è¯„ä¼°è¡¨æ ¼ + é›·è¾¾å›¾å±•ç¤ºå„å·¥å…·è¯„åˆ† + é­”éŸ³å·¥åŠå„é¡¹æŒ‡æ ‡çªå‡º + 'ROIåˆ†ææŠ¥å‘Š'ä¸“ä¸šæ ‡é¢˜ + å•†åŠ¡å›¾è¡¨é£æ ¼ + è“è‰²ä¸“ä¸šè‰²è°ƒ",
                "å°é¢ï¼šå®è—åœ°å›¾æ¦‚å¿µ + Xæ ‡è®°å„ä¸ªå¹²è´§ç‚¹ä½ç½® + é­”éŸ³å·¥åŠä½œä¸ºæœ€å¤§å®ç®± + 'å¹²è´§è—å®å›¾'å†’é™©é£æ ¼æ ‡é¢˜ + å¤åœ°å›¾çº¹ç†èƒŒæ™¯ + é‡‘è‰²å®è—å…ƒç´ "
            ]
        }
        
        suggestions = base_suggestions.get(style, [
            "å·¥å…·ç•Œé¢æˆªå›¾æ‹¼å›¾ + æ•ˆæœå¯¹æ¯”æ•°æ®",
            "ä½¿ç”¨æµç¨‹å›¾ + æˆæœå±•ç¤ºå›¾è¡¨",
            "é­”éŸ³å·¥åŠé…éŸ³å±•ç¤º + å·¥å…·ç»„åˆä½¿ç”¨æ•ˆæœå›¾"
        ])
        
        return suggestions[:count]

# åˆ›å»ºå…¨å±€ç”Ÿæˆå™¨å®ä¾‹
generator = NovelPromotionWebGenerator()

@app.route('/')
def index():
    """ä¸»é¡µ"""
    return render_template('index.html', 
                         styles=list(generator.style_configs.keys()),
                         style_configs=generator.style_configs)

@app.route('/generate', methods=['POST'])
def generate_content():
    """ç”Ÿæˆå†…å®¹API"""
    try:
        data = request.get_json()
        style1 = data.get('style1', 'å·¥å…·åˆ†äº«å‹')
        style2 = data.get('style2', 'æˆæœå±•ç¤ºå‹')
        count1 = int(data.get('count1', 8))
        count2 = int(data.get('count2', 12))
        
        # ç”Ÿæˆå•ç¯‡æ–‡æ¡ˆï¼ˆä½¿ç”¨style1å’Œcount1ï¼‰
        selected_tools = generator.select_tools_by_count(count1)
        prompt = generator.create_enhanced_prompt(style1, count1, selected_tools)
        content = generator.call_deepseek_api(prompt)
        
        main_content = {
            "é£æ ¼": style1,
            "å·¥å…·æ•°é‡": count1,
            "é€‰ä¸­å·¥å…·": [tool['name'] for tool in selected_tools] + ["é­”éŸ³å·¥åŠ"],
            "å†…å®¹": content
        }
        
        # ç”Ÿæˆæ ‡é¢˜å’Œé…å›¾å»ºè®®ï¼ˆå¢åŠ åˆ°3ä¸ªé…å›¾å»ºè®®ï¼‰
        titles = generator.generate_smart_titles(style1, 5)
        image_suggestions = generator.generate_image_suggestions(style1, 3)  # ç”Ÿæˆ3ä¸ªé…å›¾å»ºè®®
        
        result = {
            "success": True,
            "ç”Ÿæˆæ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "ä¸»ä½“æ–‡æ¡ˆ": main_content,
            "çƒ­é—¨æ ‡é¢˜": titles,
            "é…å›¾å»ºè®®": image_suggestions
        }
        
        return jsonify(result)
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"ç”Ÿæˆå¤±è´¥: {str(e)}"
        }), 500

@app.route('/tools')
def get_tools():
    """è·å–å·¥å…·ä¿¡æ¯API"""
    return jsonify({
        "é­”éŸ³å·¥åŠ": generator.moyin_comprehensive,
        "å·¥å…·åˆ†ç±»": generator.tool_categories
    })

if __name__ == '__main__':
    import os
    port = int(os.environ.get('PORT', 5000))
    app.run(debug=True, host='0.0.0.0', port=port)
